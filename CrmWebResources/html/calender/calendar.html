<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script
  type="text/javascript"
  src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"
></script>
<script type="text/javascript" src="daterangepicker.js"></script>
<link rel="stylesheet" type="text/css" href="daterangepicker.css" />

<style>
  p {
    font: 14px Verdana;
    float: right;
    margin-right: 10px;
  }
  table,
  th,
  td {
    border: solid 1px #ddd;
    border-collapse: collapse;
    padding: 2px 3px;
    text-align: center;
  }
  th {
    font-weight: bold;
  }
</style>
<div>
  <input type="text" name="daterange" />
</div>
<script>
  var _xrm = parent.Xrm;
  var _shortrent = {};
  var _inputParameter = (function () {
    var queryString = decodeURIComponent(location.search.substring(1));
    var params = {};
    var queryStringParts = queryString.split("&");
    for (var i = 0; i < queryStringParts.length; i++) {
      var pieces = queryStringParts[i].split("=");
      params[pieces[0].toLowerCase()] = pieces.length === 1 ? null : pieces[1];
    }
    return params;
  })();

  async function getShortRent(start, end) {
    var logicalName = _inputParameter.logicalname;
    var id = _inputParameter.data;
    var opportunityid = _inputParameter.opportunityid;
    var request = {
      data: {
        "@odata.type": `Microsoft.Dynamics.CRM.${logicalName}`,
        [`${logicalName}id`]: `${id}`,
      },
      opportunityRef: {
        "@odata.type": `Microsoft.Dynamics.CRM.opportunity`,
        ["opportunityid"]: `${opportunityid}`,
      },
      startDate: start.format("YYYY.MM.DD"),
      endDate: end.format("YYYY.MM.DD"),
      getMetadata: function () {
        return {
          boundParameter: null,
          parameterTypes: {
            data: {
              typeName: `${logicalName}`,
              structuralProperty: 5,
            },
            opportunityRef: {
              typeName: `opportunity`,
              structuralProperty: 5,
            },
            startDate: {
              typeName: `Edm.String`,
              structuralProperty: 1,
            },
            endDate: {
              typeName: `Edm.String`,
              structuralProperty: 1,
            },
          },
          operationType: 0,
          operationName: "sl_check_short_rent",
        };
      },
    };
    var responce = await _xrm.WebApi.online.execute(request);
    var json = await responce.json();
    var shortrent = JSON.parse(json.responce);
    if (!shortrent.IsError) {
      return shortrent;
    }
    _xrm.Utility.alertDialog(shortrent.Message);
  }

  (async function () {
    var startDateStr = _inputParameter.start;
    var endDateStr = _inputParameter.end;
    var listingid = _inputParameter.listingid;
    if (startDateStr && endDateStr) {
      var startDate = moment(startDateStr).startOf("day");
      var endDate = moment(endDateStr).startOf("day");
      var year = startDate.years();
      var month = startDate.months();
      _firstDay = moment([year, month, 1]).startOf("day");
      _lastDay = moment(_firstDay, "DD-MM-YYYY").add(2, "month").startOf("day");
      _shortrent = await getShortRent(_firstDay, _lastDay);
    }
    if (!_shortrent) return;
    var currentDateUtc = moment().startOf("day");
    var startDate = startDateStr ? moment(startDateStr).startOf("day") : currentDateUtc;
    var endDate = endDateStr ? moment(endDateStr).startOf("day") : currentDateUtc;
    _lastDay = !_lastDay
      ? moment(startDate, "DD-MM-YYYY").add(2, "month").startOf("day")
      : _lastDay;
    _firstDay = !_firstDay ? startDate : _firstDay;
    var daterange = $('input[name="daterange"]');
    daterange.daterangepicker(
      {
        startDate: startDate,
        endDate: endDate,
        opens: "left",
        minDate: currentDateUtc,
        locale: {
          format: "DD.MM.YYYY",
          applyLabel: "Check dates",
          cancelLabel: "Rent",
          rentedLabel: "Reserve",
        },
        autoUpdateInput: true,
        //autoApply: true,
        isCustomDate: (inputDate) => {
          var setCalendare = (rented) => {
            if (!rented) return;
            for (var i = 0; i < rented.length; i++) {
              var rent = rented[i];
              var from = moment(rent.dateFrom);
              var to = moment(rent.dateTo);
              if (from > _lastDay || from < _firstDay) break;
              if (inputDate >= from && inputDate <= to) return true;
            }
          };

          if (setCalendare(_shortrent.rented)) {
            return "rented";
          }

          if (setCalendare(_shortrent.reserved, "reserved")) {
            return "reserved";
          }

          if (setCalendare(_shortrent.rentedByOpportunity)) {
            return "rentedByOpportunity";
          }

          if (setCalendare(_shortrent.reservedByOpportunity)) {
            return "reservedByOpportunity";
          }
        },
      },
      checkDatesClick
    );
    async function checkDatesClick(start, end) {
      clearTable();
      var isCheck = await checkDates(start, end);
      if (!isCheck) return;
      var data = await retrivePrice(start, end);
      createTableFromJSON(data);
    }

    daterange.on("clickPrev.daterangepicker", async function (ev, picker) {
      var rightCalendar = picker.rightCalendar;
      var month = rightCalendar.month.month();
      var year = rightCalendar.month.year();
      var daysInMonth = moment([year, month]).daysInMonth();
      _lastDay = moment([year, month, daysInMonth]).startOf("day");

      var leftCalendar = picker.leftCalendar;
      var month = leftCalendar.month.month();
      var year = leftCalendar.month.year();
      _firstDay = moment([year, month, 1]).startOf("day");
      _shortrent = await getShortRent(_firstDay, _lastDay);
      picker.updateCalendars();
    });

    daterange.on("rented.daterangepicker", async function (ev, picker) {
      var start = picker.startDate.startOf("day");
      var end = picker.endDate.startOf("day");
      var responce = await reserveOrRentProperty(start, end, "588610002");
      _xrm.Utility.alertDialog(responce.Message);
    });

    async function reserveOrRentProperty(start, end, status) {
      _xrm.Utility.showProgressIndicator("Loading");
      var isCheck = await checkDates(start, end, true);
      if (!isCheck) {
        _xrm.Utility.closeProgressIndicator();
        return;
      }
      var logicalName = "sl_property_for_opportunity";
      var id = _inputParameter.propertyoppid;
      var request = {
        data: {
          "@odata.type": `Microsoft.Dynamics.CRM.${logicalName}`,
          [`${logicalName}id`]: `${id}`,
        },
        startDate: start.format("YYYY.MM.DD"),
        endDate: end.format("YYYY.MM.DD"),
        status: status,
        getMetadata: function () {
          return {
            boundParameter: null,
            parameterTypes: {
              data: {
                typeName: `${logicalName}`,
                structuralProperty: 5,
              },
              startDate: {
                typeName: `Edm.String`,
                structuralProperty: 1,
              },
              endDate: {
                typeName: `Edm.String`,
                structuralProperty: 1,
              },
              status: {
                typeName: `Edm.String`,
                structuralProperty: 1,
              },
            },
            operationType: 0,
            operationName: "sl_reserve_or_rent_property",
          };
        },
      };
      try {
        var responce = await _xrm.WebApi.online.execute(request);
        var json = await responce.json();
        return JSON.parse(json.responce);
      } catch (error) {
        return { Message: error.message };
      } finally {
        _xrm.Utility.closeProgressIndicator();
      }
    }

    async function checkDates(start, end, withRented) {
      start = start.startOf("day");
      end = end.startOf("day");
      var shortrent = await getShortRent(start, end);
      var diff = moment.duration(end - start);
      var minSpan = shortrent.minDays;
      var diffDays = diff.days();
      if (diffDays < minSpan) {
        _xrm.Utility.alertDialog(`The number of rental days is too small.`);
        return;
      }
      if (!withRented) return true;
      var checkFunc = (x) => {
        var from = new moment(x.dateFrom);
        var to = new moment(x.dateTo);
        return (
          (start >= from && start <= to) ||
          (end >= from && end <= to) ||
          (start <= from && end >= to)
        );
      };

      var rentedByOpportunity =
        shortrent.rentedByOpportunity && shortrent.rentedByOpportunity.find(checkFunc);
      if (rentedByOpportunity) {
        _xrm.Utility.alertDialog(`Dates are not available for selection`);
        return;
      }
      return true;
    }

    async function retrivePrice(startDate, endDate) {
      var logicalName = "sl_listing";
      var id = _inputParameter.listingid;
      var request = {
        data: {
          "@odata.type": `Microsoft.Dynamics.CRM.${logicalName}`,
          [`${logicalName}id`]: `${id}`,
        },
        startDate: startDate.add(1, "days").format("YYYY.MM.DD"),
        endDate: endDate.add(1, "days").format("YYYY.MM.DD"),
        getMetadata: function () {
          return {
            boundParameter: null,
            parameterTypes: {
              data: {
                typeName: `${logicalName}`,
                structuralProperty: 5,
              },
              startDate: {
                typeName: `Edm.String`,
                structuralProperty: 1,
              },
              endDate: {
                typeName: `Edm.String`,
                structuralProperty: 1,
              },
            },
            operationType: 0,
            operationName: "sl_retive_rent_price",
          };
        },
      };
      var responce = await _xrm.WebApi.online.execute(request);
      var json = await responce.json();
      var priceRange = JSON.parse(json.responce);
      if (!priceRange.IsError) {
        return priceRange;
      }
      _xrm.Utility.alertDialog(priceRange.Message);
    }

    function createTableFromJSON(data) {
      var isWithOwner = data.filter((x) => x.employee).length > 0;
      var keys = Object.keys(data[0]);
      var col = isWithOwner ? keys : keys.slice(0, 2);

      var table = document.createElement("table");
      table.id = "rent_price";
      var tr = table.insertRow(-1);
      for (var i = 0; i < col.length; i++) {
        var th = document.createElement("th");
        th.innerHTML = capitalizeFirstLetter(col[i]);
        tr.appendChild(th);
      }
      for (var i = 0; i < data.length; i++) {
        tr = table.insertRow(-1);

        for (var j = 0; j < col.length; j++) {
          var tabCell = tr.insertCell(-1);
          tabCell.innerHTML =
            col[j] == "date" ? moment(data[i][col[j]]).format("DD.MM.YYYY") : data[i][col[j]];
        }
      }
      tr = table.insertRow(-1);
      for (var j = 0; j < col.length; j++) {
        var tabCell = tr.insertCell(-1);
        var column = col[j];
        tabCell.innerHTML =
          column == "date"
            ? "Rental fee"
            : column == "price"
            ? data.map((x) => x.price).reduce((a, b) => a + b, 0)
            : "";
      }
      $(".daterangepicker").append(table);
    }

    function clearTable() {
      var divContainer = document.getElementById("rent_price");
      divContainer && divContainer.remove();
    }

    function capitalizeFirstLetter(string) {
      var split = string.split("_");
      var newSyting = split.join(" ");
      return newSyting.charAt(0).toUpperCase() + newSyting.slice(1);
    }
  })();
</script>
